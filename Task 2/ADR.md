### <a name="_b7urdng99y53"></a>**Название задачи: MVP архитектурного решения для мониторинга свиноводческих ферм** 
### <a name="_hjk0fkfyohdk"></a>**Автор: Терехин Алексей**
### <a name="_uanumrh8zrui"></a>**Дата: 26.12.2025**

### На уровне фермы:

**Внутриферменная коммуникация:** Redis Pub/Sub для событий реального времени

**Устройства → Farm Gateway:** MQTT для телеметрии, RTSP для видео

**Локальная БД:** PostgreSQL + TimescaleDB

### Ферма ↔ Облако:

**Основной протокол:** MQTT over WebSocket с QoS=1 для телеметрии и событий

**Резервный канал:** HTTPS REST API с exponential backoff

**Синхронизация:** Специализированный Sync Service с conflict resolution

### В облаке:

Межсервисная коммуникация: gRPC для синхронных вызовов, RabbitMQ для асинхронных событий

Интеграция с legacy: Kafka Connect для публикации бизнес-событий в центральную шину

**Обоснование выбора технологий**

1. MQTT для устройств и ферма-облако

    Преимущества:

    - Легкий протокол, идеален для IoT с ограниченной полосой пропускания
    - Встроенные механизмы QoS (0,1,2) гарантируют доставку
    - Pub/Sub модель хорошо ложится на сценарии телеметрии
    - Широкая поддержка железными устройствами

    Ограничение: Не подходит для bulk-передачи больших объемов данных (используем HTTPS)

    Компромисс: Требуется MQTT брокер на ферме и в облаке

2. Redis Pub/Sub для внутриферменных событий
Преимущества:

    - Субмиллисекундная задержка, что критично для оповещений <5 сек
    - Простая модель "публикация-подписка"
    - Может использоваться и как кэш, и как временное хранилище

    Ограничение: Нет гарантии доставки при падении подписчика (допустимо для MVP)

    Альтернатива: Apache Kafka

3. gRPC + RabbitMQ в облаке

    gRPC для синхронных вызовов:

    - Высокая производительность
    - Поддержка streaming
    - RabbitMQ для асинхронных событий:
    - Надежные очереди с persistence
    - Гибкая маршрутизация
    - Поддержка dead letter queues для обработки ошибок

    Компромисс: Две технологии вместо одной, но каждая лучше решает свою задачу

### Компромиссы и риски
- Компромиссы:
Сложность операций: 10+ микросервисов вместо 2-3 монолитов. Требует инвестиций в CI/CD, мониторинг, оркестрацию.

- Сетевые задержки: Межсервисные вызовы добавляют latency. Компенсируем кэшированием и async-коммуникацией где возможно.

- Синхронизация данных: Двусторонняя синхронизация ферма-облако - сложная задача. Упрощаем: облако - источник истины для конфигурации, ферма - для телеметрии в реальном времени.

### Риски и стратегии их смягчения:
- Риск: Перегрузка MQTT брокера при росте количества устройств.

Смягчение: Использовать shared subscriptions, горизонтальное масштабирование EMQX, раздельные топики по типам данных.

- Риск: Потеря данных при длительном обрыве связи с облаком.

Смягчение: Локальное хранение до 30 дней + приоритетная отправка важных событий при восстановлении.

- Риск: Сложность отладки распределенной системы.

Смягчение: Единая система логирования (ELK), распределенная трассировка (Jaeger), строгие correlation IDs.