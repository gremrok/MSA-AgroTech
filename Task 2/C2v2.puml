@startuml Диаграмма C2: Альтернативное решение - Модуль IoT-платформы
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Title Диаграмма C2: Альтернативное решение - Модуль IoT-платформы (Расширение АгроПром Х)

Person(начальник_фермы, "Начальник фермы", "Мониторинг через общий портал")
Person(дежурный, "Дежурный", "Получает оповещения")
Person(инженер, "Инженер", "Локальное управление")

' --- Существующая платформа АгроПром Х ---
System_Boundary(существующая_платформа, "Существующая платформа АгроПром Х") {
    Container(веб_портал, "Веб-портал", "React", "Расширен разделом животноводства")
    Container(мобильное_прил, "Мобильное приложение", "Flutter", "Добавлены функции по животноводству")
    Container(erp_система, "ERP система", "1С:Агро", "Учет животных, кормов, ветеринарии")
    
    Container_Boundary(iot_ядро, "IoT Ядро платформы (расширено)") {
        Container(iot_шлюз, "Единый IoT шлюз", "Node-RED", "Добавлены коннекторы для животноводческих устройств")
        Container(tsdb, "База временных рядов", "TimescaleDB", "Метрики животных и оборудования")
        Container(правила_обработки, "Движок правил", "Drools", "Бизнес-правила для животноводства")
    }
    
    Container(kafka, "Брокер сообщений", "Apache Kafka", "Центральная шина данных")
    
    ContainerDb(dwh, "Data Warehouse", "ClickHouse", "Добавлены модели данных для животноводства")
    Container(bi_система, "BI система", "Power BI", "Новые дашборды по животноводству")
}

' --- Новые компоненты для животноводства ---
System_Boundary(новые_модули, "Новые модули животноводства") {
    Container(видео_аналитика, "Сервис видеоаналитики", "Python (FastAPI)", "Облачная обработка видеопотоков")
    Container(мониторинг_здоровья, "Мониторинг здоровья", "Java (Spring)", "Анализ поведения и состояния")
    Container(управление_кормлением, "Управление кормлением", "Go", "Контроль кормушек, прогноз расхода")
    Container(ферменный_агент, "Ферменный агент", "Python", "Упрощенный сбор и буферизация данных")
}

' --- Оборудование на ферме ---
System_Boundary(оборудование, "Оборудование на ферме") {
    Container(камеры, "Камеры наблюдения", "RTSP/ONVIF", "Видеопотоки для аналитики")
    Container(датчики_кормушек, "Датчики кормушек", "Modbus/MQTT", "Уровень корма, расход")
    Container(датчики_воды, "Датчики воды", "LoRaWAN", "Качество, температура")
    Container(локальный_контроллер, "Локальный контроллер", "Raspberry Pi", "Сбор данных, буферизация")
}

' --- Внешние системы ---
System_Ext(нейросети_партнеров, "Сервис нейросетей", "Партнеры", "Облачные модели для видеоаналитики")
System_Ext(погодные_данные, "Погодные сервисы", "API", "Внешние данные для аналитики")

' === Взаимосвязи ===

' Пользователи -> Платформа
Rel(начальник_фермы, веб_портал, "Использует общий портал", "HTTPS")
Rel(инженер, мобильное_прил, "Получает уведомления", "Push")
Rel(дежурный, локальный_контроллер, "Локальное управление", "Web UI")

' Оборудование -> Ферменный агент
Rel(камеры, ферменный_агент, "RTSP потоки", "локальная сеть")
Rel(датчики_кормушек, ферменный_агент, "Данные по кормлению", "MQTT/Modbus")
Rel(датчики_воды, локальный_контроллер, "Показания датчиков", "LoRaWAN")

' Ферменный агент -> Облако
Rel(ферменный_агент, iot_шлюз, "Передача данных", "MQTT over HTTPS")
Rel(ферменный_агент, видео_аналитика, "Видеопотоки", "RTSP over VPN")

' Обработка в облаке
Rel(видео_аналитика, нейросети_партнеров, "Запросы к моделям ИИ", "HTTPS API")
Rel(видео_аналитика, kafka, "События детекции", "Kafka Protocol")
Rel(iot_шлюз, kafka, "Данные с датчиков", "Kafka Protocol")

' Бизнес-логика
Rel(kafka, правила_обработки, "Обработка событий", "Kafka Consumer")
Rel(правила_обработки, мониторинг_здоровья, "Анализ поведения", "REST API")
Rel(мониторинг_здоровья, управление_кормлением, "Рекомендации по кормлению", "Async Events")

' Хранение и аналитика
Rel(kafka, tsdb, "Сохранение метрик", "Kafka Connect")
Rel(kafka, dwh, "Структурированные данные", "ETL Pipeline")
Rel(dwh, bi_система, "Дашборды и отчеты", "ODBC")

' Интеграция с ERP
Rel(управление_кормлением, erp_система, "Заказы кормов", "REST API")
Rel(мониторинг_здоровья, erp_система, "Ветеринарные события", "REST API")

' Внешние данные
Rel(погодные_данные, мониторинг_здоровья, "Влияние погоды", "API интеграция")

' Пользовательские интерфейсы
Rel(веб_портал, мониторинг_здоровья, "Отображение состояния", "WebSocket/API")
Rel(веб_портал, управление_кормлением, "Управление кормушками", "REST API")
Rel(мобильное_прил, iot_шлюз, "Полевые данные", "HTTPS")

@enduml